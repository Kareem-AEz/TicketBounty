// https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client"
  output          = "../src/generated"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [pg_trgm]
}

// ------------------------------
// Auth
// ------------------------------

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  email         String    @unique
  emailVerified DateTime? @db.Timestamptz
  username      String    @unique
  passwordHash  String

  sessions               Session[]
  passwordResetTokens    PasswordResetToken[]
  emailVerificationToken EmailVerificationToken[]
  memberships            Membership[]
  tickets                Ticket[]
  comments               TicketComment[]
}

model Session {
  id        String   @id
  expiresAt DateTime @db.Timestamptz

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model PasswordResetToken {
  tokenHash String   @id
  createdAt DateTime @default(now()) @db.Timestamptz
  expiresAt DateTime @db.Timestamptz

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @db.Timestamptz
  expiresAt DateTime @db.Timestamptz

  email String
  code  String

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
  @@index([expiresAt])
}

// ------------------------------
// Organizations
// ------------------------------

model Organization {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  name String

  memberships Membership[]
  tickets     Ticket[]
}

model Membership {
  joinedAt DateTime @default(now()) @db.Timestamptz

  membershipRole   MembershipRole @default(MEMBER)
  isActive         Boolean        @default(false)
  canDeleteTickets Boolean        @default(false)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@id([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@index([userId, isActive])
}

enum MembershipRole {
  MEMBER
  ADMIN
}

// ------------------------------
// Tickets
// ------------------------------

model Ticket {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  title    String
  content  String       @db.Text
  status   TicketStatus @default(OPEN)
  deadline String
  bounty   Int

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  comments TicketComment[]

  // Core indexes
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([bounty])

  // Composite indexes for common query patterns
  @@index([userId, status])
  @@index([userId, createdAt])
  @@index([userId, bounty])
  @@index([status, createdAt])
  @@index([status, bounty])

  // Text search indexes
  @@index([title(ops: raw("gin_trgm_ops"))], type: Gin)
  @@index([content(ops: raw("gin_trgm_ops"))], type: Gin)
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  DONE
}

model TicketComment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @db.Timestamptz

  content String @db.Text

  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([ticketId])
  @@index([userId])
  @@index([ticketId, createdAt])
}
